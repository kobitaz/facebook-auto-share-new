{% extends "base.html" %}

{% block title %}Sharing History{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-history me-2"></i>Sharing History</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            <i class="fas fa-chevron-left me-2"></i>Back to Dashboard
        </a>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Your Sharing Tasks</h5>
        </div>
        <div class="card-body">
            {% if history %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Post URL</th>
                                <th>Shares</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in history %}
                            <tr>
                                <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width: 200px;">
                                        {{ item.post_url }}
                                    </span>
                                </td>
                                <td>{{ item.current_count }}/{{ item.share_count }}</td>
                                <td>
                                    <div class="progress" style="height: 15px;">
                                        {% set progress = (item.current_count / item.share_count * 100)|round|int %}
                                        <div class="progress-bar 
                                            {% if item.status == 'running' %}
                                                progress-bar-striped progress-bar-animated
                                            {% elif item.status == 'completed' %}
                                                bg-success
                                            {% elif item.status == 'failed' %}
                                                bg-danger
                                            {% elif item.status == 'paused' %}
                                                bg-warning
                                            {% endif %}"
                                            role="progressbar" style="width: {{ progress }}%;"
                                            aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ progress }}%</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if item.status == 'running' %}
                                            bg-primary
                                        {% elif item.status == 'completed' %}
                                            bg-success
                                        {% elif item.status == 'failed' %}
                                            bg-danger
                                        {% elif item.status == 'paused' %}
                                            bg-warning
                                        {% endif %}">
                                        {{ item.status|capitalize }}
                                    </span>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary view-details-btn" 
                                        data-bs-toggle="modal" data-bs-target="#taskDetailsModal" 
                                        data-task-id="{{ item.task_id }}">
                                        <i class="fas fa-eye me-1"></i>Details
                                    </button>
                                    
                                    {% if item.status == 'running' %}
                                        <button type="button" class="btn btn-sm btn-warning pause-task-btn" 
                                            data-task-id="{{ item.task_id }}">
                                            <i class="fas fa-pause me-1"></i>Pause
                                        </button>
                                    {% endif %}
                                    
                                    {% if item.status == 'paused' %}
                                        <button type="button" class="btn btn-sm btn-success resume-task-btn" 
                                            data-task-id="{{ item.task_id }}" data-bs-toggle="modal" 
                                            data-bs-target="#resumeTaskModal">
                                            <i class="fas fa-play me-1"></i>Resume
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-history fa-4x mb-3 text-muted"></i>
                    <p class="text-muted">You haven't shared any posts yet.<br>Go to the dashboard to start sharing.</p>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary mt-3">
                        <i class="fas fa-share-alt me-2"></i>Start Sharing
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4" id="taskDetailsLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading task details...</p>
                </div>
                
                <div id="taskDetailsContent" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold">Post URL</h6>
                            <p id="detailPostUrl" class="text-break"></p>
                            
                            <h6 class="fw-bold">Task ID</h6>
                            <p id="detailTaskId" class="text-monospace"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">Status</h6>
                            <p><span id="detailStatus" class="badge"></span></p>
                            
                            <h6 class="fw-bold">Progress</h6>
                            <div class="progress mb-2" style="height: 20px;">
                                <div id="detailProgressBar" class="progress-bar" role="progressbar" 
                                    style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <p class="text-muted"><span id="detailProgressText">0/0</span> shares completed</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="fw-bold">Created</h6>
                            <p id="detailCreatedAt"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">Completed</h6>
                            <p id="detailCompletedAt"></p>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold">Task Log</h6>
                    <div id="detailLogMessages" class="p-3 bg-light rounded" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">No messages available</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                
                <div id="taskActionButtons">
                    <button type="button" id="pauseTaskModalBtn" class="btn btn-warning" style="display: none;">
                        <i class="fas fa-pause me-1"></i>Pause
                    </button>
                    
                    <button type="button" id="resumeTaskModalBtn" class="btn btn-success" style="display: none;" data-bs-toggle="modal" 
                        data-bs-target="#resumeTaskModal" data-bs-dismiss="modal">
                        <i class="fas fa-play me-1"></i>Resume
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resume Task Modal -->
<div class="modal fade" id="resumeTaskModal" tabindex="-1" aria-labelledby="resumeTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resumeTaskModalLabel">Resume Sharing Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>To resume sharing, you need to provide your Facebook cookie again for security reasons.</p>
                
                <div class="mb-3">
                    <label for="resumeCookieJson" class="form-label">Facebook Cookie (JSON format)</label>
                    <textarea class="form-control" id="resumeCookieJson" rows="5" placeholder='[{"key":"c_user","value":"..."},...]' required></textarea>
                    <div class="form-text">Paste your Facebook cookie in JSON format. Use the Cookie Getter if needed.</div>
                </div>
                
                <input type="hidden" id="resumeTaskId" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmResumeBtn">
                    <i class="fas fa-play me-1"></i>Resume Sharing
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // View task details
        document.querySelectorAll('.view-details-btn').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                loadTaskDetails(taskId);
            });
        });
        
        // Pause running task
        document.querySelectorAll('.pause-task-btn').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                pauseTask(taskId);
            });
        });
        
        // Set task ID for resume modal
        document.querySelectorAll('.resume-task-btn').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                document.getElementById('resumeTaskId').value = taskId;
            });
        });
        
        // Resume task
        document.getElementById('confirmResumeBtn').addEventListener('click', function() {
            const taskId = document.getElementById('resumeTaskId').value;
            const cookieJson = document.getElementById('resumeCookieJson').value;
            
            if (!cookieJson.trim()) {
                alert('Please enter your Facebook cookie to resume sharing.');
                return;
            }
            
            resumeTask(taskId, cookieJson);
        });
        
        // Pause task from modal
        document.getElementById('pauseTaskModalBtn').addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            pauseTask(taskId);
        });
        
        // Set task ID for resume modal from detail view
        document.getElementById('resumeTaskModalBtn').addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            document.getElementById('resumeTaskId').value = taskId;
        });
    });
    
    function loadTaskDetails(taskId) {
        // Show loading, hide content
        document.getElementById('taskDetailsLoading').style.display = 'block';
        document.getElementById('taskDetailsContent').style.display = 'none';
        
        // Clear action buttons
        document.getElementById('pauseTaskModalBtn').style.display = 'none';
        document.getElementById('resumeTaskModalBtn').style.display = 'none';
        
        fetch(`/api/check_share_status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update task details based on the retrieved data
                    const result = data.result;
                    
                    // Find the history item with the matching task_id
                    const historyItems = Array.from(document.querySelectorAll('tr')).filter(
                        tr => tr.querySelector('.view-details-btn')?.getAttribute('data-task-id') === taskId
                    );
                    
                    if (historyItems.length > 0) {
                        const historyItem = historyItems[0];
                        
                        // Extract details from history item
                        const postUrl = historyItem.querySelector('td:nth-child(2) span').textContent.trim();
                        const createdAt = historyItem.querySelector('td:nth-child(1)').textContent.trim();
                        
                        // Set basic info
                        document.getElementById('detailPostUrl').textContent = postUrl;
                        document.getElementById('detailTaskId').textContent = taskId;
                        document.getElementById('detailCreatedAt').textContent = createdAt;
                        
                        // Set status badge
                        const statusBadge = document.getElementById('detailStatus');
                        statusBadge.textContent = result.status.charAt(0).toUpperCase() + result.status.slice(1);
                        
                        if (result.status === 'running') {
                            statusBadge.className = 'badge bg-primary';
                            document.getElementById('pauseTaskModalBtn').style.display = 'inline-block';
                            document.getElementById('pauseTaskModalBtn').setAttribute('data-task-id', taskId);
                        } else if (result.status === 'completed') {
                            statusBadge.className = 'badge bg-success';
                        } else if (result.status === 'failed') {
                            statusBadge.className = 'badge bg-danger';
                        } else if (result.status === 'paused') {
                            statusBadge.className = 'badge bg-warning';
                            document.getElementById('resumeTaskModalBtn').style.display = 'inline-block';
                            document.getElementById('resumeTaskModalBtn').setAttribute('data-task-id', taskId);
                        }
                        
                        // Set completed at date if available
                        if (result.completed_at) {
                            document.getElementById('detailCompletedAt').textContent = result.completed_at;
                        } else {
                            document.getElementById('detailCompletedAt').textContent = 'Not yet completed';
                        }
                        
                        // Set progress bar
                        const progressPercent = Math.round((result.current / result.total) * 100);
                        const progressBar = document.getElementById('detailProgressBar');
                        progressBar.style.width = `${progressPercent}%`;
                        progressBar.textContent = `${progressPercent}%`;
                        progressBar.setAttribute('aria-valuenow', progressPercent);
                        
                        if (result.status === 'running') {
                            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
                        } else if (result.status === 'completed') {
                            progressBar.className = 'progress-bar bg-success';
                        } else if (result.status === 'failed') {
                            progressBar.className = 'progress-bar bg-danger';
                        } else if (result.status === 'paused') {
                            progressBar.className = 'progress-bar bg-warning';
                        }
                        
                        // Set progress text
                        document.getElementById('detailProgressText').textContent = `${result.current}/${result.total}`;
                        
                        // Display messages
                        const messagesContainer = document.getElementById('detailLogMessages');
                        if (result.messages && result.messages.length > 0) {
                            messagesContainer.innerHTML = '';
                            
                            result.messages.forEach(msg => {
                                const msgElement = document.createElement('div');
                                msgElement.className = 'mb-2 log-message';
                                
                                let msgClass = '';
                                let icon = '';
                                
                                if (msg.type === 'info') {
                                    msgClass = 'text-info';
                                    icon = '<i class="fas fa-info-circle me-2"></i>';
                                } else if (msg.type === 'success') {
                                    msgClass = 'text-success';
                                    icon = '<i class="fas fa-check-circle me-2"></i>';
                                } else if (msg.type === 'error') {
                                    msgClass = 'text-danger';
                                    icon = '<i class="fas fa-exclamation-circle me-2"></i>';
                                } else if (msg.type === 'warning') {
                                    msgClass = 'text-warning';
                                    icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
                                } else if (msg.type === 'status') {
                                    msgClass = 'text-primary';
                                    icon = '<i class="fas fa-spinner me-2"></i>';
                                }
                                
                                msgElement.className += ` ${msgClass}`;
                                msgElement.innerHTML = `${icon}${msg.message}`;
                                messagesContainer.appendChild(msgElement);
                            });
                            
                            // Auto-scroll to bottom
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        } else {
                            messagesContainer.innerHTML = '<div class="text-center text-muted py-3">No messages available</div>';
                        }
                    }
                    
                    // Show content, hide loading
                    document.getElementById('taskDetailsLoading').style.display = 'none';
                    document.getElementById('taskDetailsContent').style.display = 'block';
                } else {
                    // Show error
                    document.getElementById('taskDetailsLoading').style.display = 'none';
                    document.getElementById('taskDetailsContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading task details: ${data.error || 'Unknown error'}
                        </div>
                    `;
                    document.getElementById('taskDetailsContent').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('taskDetailsLoading').style.display = 'none';
                document.getElementById('taskDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading task details. Please try again.
                    </div>
                `;
                document.getElementById('taskDetailsContent').style.display = 'block';
            });
    }
    
    function pauseTask(taskId) {
        if (!confirm('Are you sure you want to pause this sharing task?')) {
            return;
        }
        
        fetch(`/api/pause_sharing/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Task paused successfully! You can resume it later from the history page.');
                    location.reload();
                } else {
                    alert(`Error pausing task: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error pausing task. Please try again.');
            });
    }
    
    function resumeTask(taskId, cookieText) {
        try {
            // Validate the cookie JSON
            const cookieJson = JSON.parse(cookieText);
            
            fetch(`/api/resume_sharing/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cookie: cookieJson
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Task resumed successfully!');
                    location.reload();
                } else {
                    alert(`Error resuming task: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error resuming task. Please try again.');
            });
        } catch (e) {
            alert('Invalid cookie format. Please make sure it is valid JSON.');
        }
    }
</script>
{% endblock %}